LoadModule headers_module modules/mod_headers.so
LoadModule ssl_module modules/mod_ssl.so


Listen 80
<VirtualHost *:80>
    LogFormat "%h %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b" common
    LogFormat "%{Referer}i -> %U" referer
    LogFormat "%{User-agent}i" agent
    RewriteEngine on
    RewriteCond %{REMOTE_ADDR} !^128\.142\.14[2-3]\.[0-9]+
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]
    WSGIApplicationGroup %{GLOBAL}
    WSGIScriptAlias /prodview /var/www/wsgi-scripts/prodview.wsgi
    WSGIScriptAlias /analysisview /var/www/wsgi-scripts/prodview.wsgi
    WSGIScriptAlias /analysiscrab2view /var/www/wsgi-scripts/prodview.wsgi
    WSGIScriptAlias /totalview /var/www/wsgi-scripts/prodview.wsgi
    WSGIScriptAlias /poolview /var/www/wsgi-scripts/prodview.wsgi
    WSGIScriptAlias /factoryview /var/www/wsgi-scripts/prodview.wsgi
    <Directory /var/www/wsgi-scripts>
        SetHandler None
        FileETag none
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Directory>
</VirtualHost>

# Load the SSL and Shibboleth modules
LoadModule ssl_module modules/mod_ssl.so
LoadModule mod_shib /usr/lib64/shibboleth/mod_shib_22.so

TraceEnable Off

# Listen on 433 for SSL
Listen 443

# These settings are taken directly from the default ssl.conf file
SSLPassPhraseDialog  builtin
SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300
SSLMutex default
SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin
SSLCryptoDevice builtin

#Define the behaviour for our SSL-encypted host
<VirtualHost *:443>
  Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains;"
  LimitRequestFieldSize 131040
  LimitRequestLine 131040
  LogFormat "%h %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
  LogFormat "%h %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b" common
  LogFormat "%{Referer}i -> %U" referer
  LogFormat "%{User-agent}i" agent
  # Enable SSL and define some host-specific settings
  SSLEngine on
  SSLProtocol -All +TLSv1 +TLSv1.1 +TLSv1.2
  SSLCipherSuite HIGH:!aNULL:!eNULL:!kECDH:!aDH:!RC4:!3DES:!CAMELLIA:!MD5:!PSK:!SRP:!KRB5:@STRENGTH
  #SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
  SSLCertificateFile /etc/pki/tls/certs/host.cert
  SSLCertificateKeyFile /etc/pki/tls/private/privkey.pem
  SSLCertificateChainFile /etc/pki/tls/certs/CERN-bundle.pem
  # Bad browser support
  SetEnvIf User-Agent ".*MSIE.*" \
           nokeepalive ssl-unclean-shutdown \
           downgrade-1.0 force-response-1.0

  # Logging to the default Apache log directory (/var/log/httpd on SLC6)
  ErrorLog "|/usr/sbin/rotatelogs /var/log/httpd/logs/sso_error_log 86400"
  TransferLog "|/usr/sbin/rotatelogs /var/log/httpd/logs/sso_access_log 86400"
  CustomLog "|/usr/sbin/rotatelogs /var/log/httpd/logs/sso_request_log 86400" \
    "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{SSL_CLIENT_DN}x %{SSL_CLIENT_S_DN}x \"%r\" %b"
  LogLevel warn

  # Make sure that the handlers are always available
  <Location /Shibboleth.sso>
    Satisfy Any
    Allow from all
  </Location>

  # Aliases for resources used in Shibboleth error templates.
  <IfModule mod_alias.c>
    <Location /shibboleth-sp>
      Satisfy Any
      Allow from all
    </Location>
    Alias /shibboleth-sp/main.css /usr/share/shibboleth/main.css
    # logo.jpg doesn't come with a Shibboleth install, unlike main.css
    # If you would like a logo shown on Shibboleth error pages, you can place
    # one called logo.jpg in /usr/share/shibboleth
    Alias /shibboleth-sp/logo.jpg /usr/share/shibboleth/logo.jpg
  </IfModule>

  # This location requires authentication
  # When the user hits /, they will be redirect to the CERN SSO page by
  # Shibboleth, then redirected back to / via /Shibboleth.sso/ADFS,
  # on successful authentication
  <Location />
    AuthType shibboleth
    ShibCompatWith24 On
    ShibRequestSetting requireSession 1
    ShibUseHeaders On
    require shib-session
  </Location>

  WSGIScriptAlias /prodview /var/www/wsgi-scripts/prodview.wsgi
  WSGIScriptAlias /analysisview /var/www/wsgi-scripts/prodview.wsgi
  WSGIScriptAlias /analysiscrab2view /var/www/wsgi-scripts/prodview.wsgi
  WSGIScriptAlias /totalview /var/www/wsgi-scripts/prodview.wsgi
  WSGIScriptAlias /poolview /var/www/wsgi-scripts/prodview.wsgi
  WSGIScriptAlias /factoryview /var/www/wsgi-scripts/prodview.wsgi
  <Directory /var/www/wsgi-scripts>
      SetHandler None
      FileETag none
      Options FollowSymLinks
      Order allow,deny
      Allow from all
  </Directory>

</VirtualHost>
